---
title: JVM
date: 2018-07-21 22:43:53
categories:
tags:
---

​	当我们在使用一种技术时，如果不再依赖书本和他人就能得到这些问题的答案，那才算上升到了“不惑”的境界

​																									----周志明







执行java代码首先要将其编译成的class文件加载到java虚拟机中，加载后的Java类会被存放于方法区(Method Area)中。实际运行时，虚拟机会执行方法区内的代码。每当调用进入一个Java方法，JVM就会在当前线程的Java方法栈里生成一个栈帧，用于存放局部变量以及字节码的操作数。这个栈帧的大小是提前计算好的，而且JVM不要求栈帧在内存空间里连续分布。当退出当前执行方法时，不管是正常返回还是异常返回，JVM都会弹出当前线程的当前栈帧，并将之舍弃。总之JVM将Java字节码翻译成机器码以供计算机直接执行。

	在HotSpot虚拟机里面，通过解释执行、即时编译两种形式将字节码翻译成机器码。

   * 解释执行：逐条将字节码翻译成机器码并执行。

   * 即时编译(Just-In-Time compilation,JIT)：将一个方法中包含的所有字节码翻译成机器码后再执行。

     

     解释执行的优势在于不需要等待编译，边编译边执行。而即时编译的优势在于实际运行速度更快。HotSpot默认采取的是混合模式，它会先解释执行字节码，而后将其反复执行的==热点代码==，以方法为单位进行即时编译。

![1532217599533](C:\Users\zhangchi\AppData\Local\Temp\1532217599533.png)

	为了满足不同的用户场景需求，HotSpot内置了多个即时编译器：C1、C2、Graal。之所以引入多个即时编译器，是为了在编译时间和生产代码的执行效率之间进行取舍。C1又叫做Client编译器，主要适用对启动性能有要求的客户端程序，采用的优化手段相对简单因此编译时间较短。C2又叫做Server编译器，主要适用对峰值性能有要求的服务端程序，采用的优化手段相对复杂，因此编译时间较长，但同时生成代码的执行效率较高。Graal是Java10正式引入的试验性编译器。从Java7开始HotSpot默认采用分层编译的方式：热点方法首先会被C1编译执行，而后热点方法中的热热点代码会进一步被C2编译。为了不干扰应用的正常运行，HotSpot的即时编译是放在额外的编译线程中进行的。HotSpot会根据CPU的数量设置编译线程的数目，并且按照1:2的比例分配给C1和C2编译器。在计算资源充足的情况下，字节码的解释执行和即时编译可同时进行。编译完成后的机器码会在下次调用该方法时启用，已替换原本的编译执行。